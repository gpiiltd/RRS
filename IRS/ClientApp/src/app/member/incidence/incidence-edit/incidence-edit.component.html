
<form [formGroup]="incidentForm" #formDir="ngForm" (ngSubmit)="submit()" class="form form-horizontal" id="incidentFormId">
  <section>
    <div class="row text-left">
      <!--Nav justification Starts-->
      <div class="col-md-12 col-lg-12">
        <div class="card">
          <div class="card-header">
            <h4 class="card-title">{{ModalTitle}}</h4>
          </div>
          <div class="card-content">
            <div *ngIf="incidentForm.invalid && formDir.submitted" class="col-sm-8 alert alert-danger ml-3">
                  <p><strong>Error: </strong>You have an invalid input in one of the tabs. Please check.</p>
            </div>
            <div class="card-body">
              <ngb-tabset [justify]="currentJustify">
                <ngb-tab>
                    <ng-template ngbTabTitle> General Info</ng-template>
                    <ng-template ngbTabContent>
                    <h4 class="form-section"><i class="ft-user"></i> General Info</h4>
                    
                    
                        <div class="row">
                            <div class="col-xl-3 col-lg-6 col-md-12">
                                <fieldset class="form-group">
                                    <label for="title">Code:</label>
                                    <input type="text" id="" class="form-control" placeholder="Code" formControlName="code">
                                </fieldset>                                
                            </div>
                            <!-- <div class="col-xl-3 col-lg-6 col-md-12">
                                <fieldset class="form-group">
                                    <label for="title">Title:</label>
                                    <input type="text" id="" class="form-control" placeholder="Title" formControlName="title" [ngClass]="{'is-invalid': incidentForm.get('title').errors && (formDir.submitted || incidentForm.get('title').touched) }">
                                    <div class="" *ngIf="incidentForm.get('title').hasError('required') && (formDir.submitted || incidentForm.get('title').touched)">Title is required</div>
                                </fieldset>                                
                            </div> -->
                            <div class="col-xl-3 col-lg-6 col-md-12">
                                <fieldset class="form-group">
                                    <label for="routeCause">Route Cause:</label>
                                    <input type="text" id="" class="form-control" placeholder="Route Cause" formControlName="routeCause" >
                                </fieldset>                                
                              </div>
                            <div class="col-xl-6 col-lg-6 col-md-12">
                                <fieldset class="form-group">
                                    <label for="description">Description:</label>
                                    <textarea class="form-control" id="" formControlName="description" rows="2" placeholder="Description:" [ngClass]="{'is-invalid': incidentForm.get('description').errors && (formDir.submitted || incidentForm.get('description').touched) }"></textarea>
                                    <div class="" *ngIf="incidentForm.get('description').hasError('required') && (formDir.submitted || incidentForm.get('description').touched)">Description is required</div>
                                  </fieldset>                                
                            </div>
                            
                          </div>
                          <div class="row">
                            <div class="col-xl-3 col-lg-6 col-md-12">
                                <fieldset class="form-group">
                                    <label for="assignedOrganizationId">Assigned Organization: </label>
                                    <select class="form-control" id="" (change)="onOrganizationChange()" formControlName="assignedOrganizationId" placeholder="Organization" >
                                        <option value=""></option>
                                        <option *ngFor="let org of organizationList" [value]="org.id">{{org.name}}</option>
                                    </select>
                                </fieldset>                                
                            </div>
                            <div class="col-xl-3 col-lg-6 col-md-12">
                                <fieldset class="form-group">
                                    <label for="assignedDepartmentId">Assigned Department:</label>
                                    <select class="form-control" id="" (change)="onDepartmentChange()" formControlName="assignedDepartmentId" placeholder="Department">
                                        <option value=""></option>
                                        <option *ngFor="let dept of departmentList" [value]="dept.id">{{dept.name}}</option>
                                    </select>
                                </fieldset>                                
                            </div>
                            <div class="col-xl-3 col-lg-6 col-md-12">
                                <fieldset class="form-group">
                                    <label for="assignerId">Assigner: </label>
                                    <select class="form-control" id="" formControlName="assignerId" placeholder="Assigner">
                                        <option value=""></option>
                                        <option *ngFor="let user of allUserList" [value]="user.id">{{user.name}}</option>
                                    </select>
                                </fieldset>                                
                            </div>
                            <div class="col-xl-3 col-lg-6 col-md-12">
                                <fieldset class="form-group">
                                    <label for="assigneeId">Assignee:</label>
                                    <select class="form-control" id="" formControlName="assigneeId" placeholder="Assignee" [ngClass]="{'is-invalid': incidentForm.get('assigneeId').errors && (formDir.submitted || incidentForm.get('assigneeId').touched) }">
                                        <option value=""></option>
                                        <option *ngFor="let user of userList" [value]="user.id">{{user.name}}</option>
                                    </select>
                                    <div class="" *ngIf="incidentForm.get('assigneeId').hasError('required') && (formDir.submitted || incidentForm.get('assigneeId').touched)">Assignee is required when Incidence Status is Open or Re-Opened</div>
                                </fieldset>                                
                            </div>
                          </div>
                          <div class="row">
                              
                              <div class="col-xl-6 col-lg-6 col-md-12">
                                  <fieldset class="form-group">
                                      <label for="comment">Comment: </label>
                                      <textarea class="form-control" id="" formControlName="comment" rows="2" placeholder="Comment:"></textarea>
                                  </fieldset>                                
                              </div>
                              <div class="col-xl-6 col-lg-6 col-md-12">
                                  <fieldset class="form-group">
                                      <label for="suggestion">Suggestion:</label>
                                      <textarea class="form-control" id="" formControlName="suggestion" rows="2" placeholder="Suggestion:"></textarea>
                                  </fieldset>                                
                              </div>
                          </div>
                          <div class="row">
                              <div class="col-xl-3 col-lg-6 col-md-12">
                                  <fieldset class="form-group">
                                      <label for="incidenceTypeId">Incidence Type: </label>
                                      <select class="form-control" id="" formControlName="incidenceTypeId" placeholder="Incidence Type" [ngClass]="{'is-invalid': incidentForm.get('incidenceTypeId').errors && (formDir.submitted || incidentForm.get('incidenceTypeId').touched) }">
                                          <option value=""></option>
                                          <option *ngFor="let incType of incidenceTypeList" [value]="incType.id">{{incType.name}}</option>
                                      </select>
                                      <div class="" *ngIf="incidentForm.get('incidenceTypeId').hasError('required') && (formDir.submitted || incidentForm.get('incidenceTypeId').touched)">The Incidence Type is required</div>
                                  </fieldset>                                
                              </div>
                              <div class="col-xl-3 col-lg-6 col-md-12">
                                  <fieldset class="form-group">
                                      <label for="incidenceStatusId">Incidence Status:</label>
                                      <select class="form-control" id="" formControlName="incidenceStatusId" placeholder="Incidence Status" [ngClass]="{'is-invalid': incidentForm.get('incidenceStatusId').errors && incidentForm.get('incidenceStatusId').touched || incidentForm.hasError('unpermitted') && incidentForm.get('incidenceStatusId').touched}" >
                                          <option value="" ></option>
                                          <option *ngFor="let incStatus of incidenceStatusList" [value]="incStatus.id">{{incStatus.name}}</option>
                                      </select>
                                      <div class="" *ngIf="incidentForm.get('incidenceStatusId').hasError('unpermitted') && incidentForm.get('incidenceStatusId').touched">You do not have the permission to review or close incidences</div>
                                  </fieldset>                                
                              </div>
                              <div class="col-xl-3 col-lg-6 col-md-12">
                                  <fieldset class="form-group">
                                      <label for="resolutionDate">Resolution Date:</label>
                                          <input
                                            class="form-control"
                                            placeholder="Date of Resolution"
                                            bsDatepicker
                                            formControlName="resolutionDate"
                                            [bsConfig]="{ dateInputFormat: 'YYYY-MM-DD', containerClass: 'theme-dark-blue' }">
                                  </fieldset>                                
                              </div>
                              <div class="col-xl-3 col-lg-6 col-md-12">
                                  <fieldset class="form-group">
                                      <label for="incidenceManagerFeedbackRating">Manager's Rating:</label>
                                      <div class="mt-1">
                                        <ngb-rating [(rate)]="incidenceManagerFeedbackRating" [readonly]="!isManagerialUser" max="5">
                                            <ng-template let-fill="fill">
                                              <span class="star" [class.filled]="fill === 100">&#9733;</span>
                                            </ng-template>
                                        </ngb-rating>
                                      </div>
                                  </fieldset>                                
                              </div>
                            
                          </div>
                    
                    </ng-template>
                  </ngb-tab>
                  <ngb-tab>
                  <ng-template ngbTabTitle>Reporter's Details</ng-template>
                    <ng-template ngbTabContent>
                    <h4 class="form-section"><i class="ft-user"></i> Reporter's Info</h4>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group row">
                          <label class="col-md-3 label-control" for="reporterName">Reporter's Name: </label>
                          <div class="col-md-9">
                            <input type="text" id="" class="form-control" placeholder="Reporter" formControlName="reporterName" >
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group row">
                          <label class="col-md-3 label-control" for="reporterEmail">Reporter's Email: </label>
                          <div class="col-md-9">
                            <input type="text" id="" class="form-control" placeholder="Reporter Email" formControlName="reporterEmail" >
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                          <div class="form-group row">
                            <label class="col-md-3 label-control" for="reporterDepartmentId">Reporter's Department: </label>
                            <div class="col-md-9">
                                <select class="form-control" id="" formControlName="reporterDepartmentId" placeholder="Reporter's Department">
                                    <option value=""></option>
                                    <option *ngFor="let dept of departmentList" [value]="dept.id">{{dept.name}}</option>
                                </select>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-md-3 label-control" for="incidenceReporterFeedbackRating">Reporter's Rating: </label>
                                <div class="col-md-9">
                                  <!-- <input type="text" id="" class="form-control" placeholder="Reporter" formControlName="reporterFeedbackRating"> -->
                                  <ngb-rating [(rate)]="incidenceReporterFeedbackRating" [readonly]="true" max="5">
                                      <ng-template let-fill="fill">
                                        <span class="star" [class.filled]="fill === 100">&#9733;</span>
                                      </ng-template>
                                  </ngb-rating>
                                </div>
                            </div>
                        </div>      
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                            <div class="form-group row">
                              <label class="col-md-3 label-control" for="reporterFirstResponderAction">First Responder Action: </label>
                              <div class="col-md-9">
                                  <textarea class="form-control" id="" formControlName="reporterFirstResponderAction" rows="3" placeholder="First Responder Action:"></textarea>
                              </div>
                            </div>
                          </div>     
                      </div>
                      
                  </ng-template>
                </ngb-tab>
                <ngb-tab>
                <ng-template ngbTabTitle>Location Details</ng-template>
                  <ng-template ngbTabContent>
                    <h4 class="form-section"><i class="ft-info"></i> Location</h4>
                    <div class="row">
                        <div class="col-xl-3 col-lg-6 col-md-12">
                            <fieldset class="form-group">
                                <label for="countryId">Country </label>
                                <select class="form-control" (change)="onCountryChange()" id="" formControlName="countryId">
                                    <option value=""></option>
                                    <option *ngFor="let country of countryList" [value]="country.id">{{country.name}}</option>
                                </select>
                            </fieldset>                                
                        </div>
                        <div class="col-xl-3 col-lg-6 col-md-12">
                            <fieldset class="form-group">
                                <label for="stateId">State </label>
                                <select class="form-control" (change)="onStateChange()" id="" formControlName="stateId">
                                    <option value=""></option>
                                    <option *ngFor="let state of stateList" [value]="state.id">{{state.name}}</option>
                                </select>
                            </fieldset>                                
                        </div>
                        <div class="col-xl-3 col-lg-6 col-md-12">
                            <fieldset class="form-group">
                                <label for="countryId">City </label>
                                <select class="form-control" id="" formControlName="cityId">
                                    <option value=""></option>
                                    <option *ngFor="let city of cityList" [value]="city.id">{{city.name}}</option>
                                </select>
                            </fieldset>                                
                        </div>
                        <div class="col-xl-3 col-lg-6 col-md-12">
                          <fieldset class="form-group">
                              <label for="areaId">Area </label>
                              <select class="form-control" id="" formControlName="areaId">
                                  <option value=""></option>
                                  <option *ngFor="let area of areaList" [value]="area.id">{{area.name}}</option>
                              </select>
                          </fieldset>                                
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xl-3 col-lg-6 col-md-12">
                            <fieldset class="form-group">
                                <label for="reportedIncidenceLatitude">Latitude: </label>
                                <input type="text" id="" class="form-control" placeholder="Latitude" formControlName="reportedIncidenceLatitude">
                            </fieldset>                                
                        </div>
                        <div class="col-xl-3 col-lg-6 col-md-12">
                            <fieldset class="form-group">
                                <label for="reportedIncidenceLongitude">Longitude: </label>
                                <input type="text" id="" class="form-control" placeholder="Longitude" formControlName="reportedIncidenceLongitude">
                            </fieldset>                                
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-12">
                            <fieldset class="form-group">
                                <label for="address">Address: </label>
                                <textarea class="form-control" id="" formControlName="address" rows="3" placeholder="Address:"  [ngClass]="{'is-invalid': incidentForm.get('address').errors && (formDir.submitted || incidentForm.get('address').touched) }"></textarea>
                                <div class="" *ngIf="incidentForm.get('address').hasError('required') && (formDir.submitted || incidentForm.get('address').touched)">Address of occurence is required</div>
                            </fieldset>                                
                        </div>
                    </div>
                    
                      </ng-template>
                </ngb-tab>
                <ngb-tab *ngIf="isEditMode">
                    <ng-template ngbTabTitle>Reported Photos/Videos</ng-template>
                    <ng-template ngbTabContent>
                        <div class="">
                          <h4>Toggle Photos or Videos</h4>
                          <div class="form-group">
                            <ui-switch class="ml-2 float-left" (change)="onChange()">
                            </ui-switch>

                            <div class="float-right" *ngIf="showUploadFileButtons">
                                <label for="file-upload" class="custom-file-upload btn btn-raised btn-raised btn-primary ml-4">
                                  <input id="file-upload" #fileInput multiple (change)="uploadPhoto(mediaChannel.mobileReported)" type="file"/>
                                  <span class="label-text">Upload Photo/Video</span><i class="fa ft-paperclip ml-1"></i>
                                </label>
                            </div>
                          </div>
                          </div>
                        <div id="" class="" *ngIf=photoVideoToggle>
                            <h4 class="form-section mt-5"><i class="ft-info"></i> Photos</h4>

                            <div class="progress mt-1" *ngIf="progress && progress.percentage < 100">
                                <div class="progress-bar" [style.width]="progress.percentage + '%'">
                                  <span class="sr-only">{{ progress.percentage }}% Complete</span>
                                </div>
                              </div>
                              <div class="right pb-4" *ngIf="isOrgAdminUser">
                                  <h5>Manage Photos</h5>
                                  <div class="form-group">
                                      <ui-switch class="ml-2 float-left" (change)="manageReportedPhotos()">
                                      </ui-switch>
                                  </div>
                              </div>
                              <div *ngIf="!showManageReportedPhotos" class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <ng-image-slider [images]="incidenceReportedPhotos" 
                                [imageSize]="{width: sliderImageWidth, height: sliderImageHeight}" class="" #nav>> </ng-image-slider>
                              </div>
                              <div *ngIf="showManageReportedPhotos">
                                  <app-photo-editor [photos]="incidenceReportedPhotos" ></app-photo-editor>
                              </div>
                        </div>
                        <div id="" class="" *ngIf=!photoVideoToggle>
                            <div class="videoMaxWrapper">
                              <h4 class="form-section mt-5"><i class="ft-info"></i> Videos</h4>
                              <div class="right pb-4" *ngIf="isOrgAdminUser">
                                  <h5>Manage Videos</h5>
                                  <div class="form-group">
                                      <ui-switch class="ml-2 float-left" (change)="manageReportedVideos()">
                                      </ui-switch>
                                  </div>
                              </div>
                              <div *ngIf="!showManageReportedVideos" >
                                <ng-image-slider [images]="incidenceReportedVideos" 
                                [imageSize]="{width: sliderImageWidth, height: sliderImageHeight}"#nav>
                              </ng-image-slider>
                              </div>
                              <div *ngIf="showManageReportedVideos">
                                <app-video-editor [videos]="incidenceReportedVideos"></app-video-editor>
                              </div>

                              <!-- <div *ngIf="!showManageResolutionVideos">
                                <ng-image-slider [images]="incidenceReportedVideos" #nav></ng-image-slider>
                            </div>
                            <div *ngIf="showManageResolutionPhotos">
                                <app-photo-editor [photos]="incidenceResolutionPhotos"></app-photo-editor>
                              </div> -->
                          </div>
                        </div>
                    </ng-template>
                </ngb-tab>
                <ngb-tab *ngIf="isEditMode">
                    <ng-template ngbTabTitle>Resolution Photos/Videos</ng-template>
                    <ng-template ngbTabContent>
                      <div class="">
                        <h4>Toggle Photos or Videos</h4>
                        <div class="form-group">
                        <ui-switch class="ml-2 float-left" (change)="onChange()">
                        </ui-switch>

                        <div class="float-right" *ngIf="showUploadFileButtons">
                          <label for="file-upload" class="custom-file-upload btn btn-raised btn-raised btn-primary ml-4">
                            <input id="file-upload" #fileInput multiple (change)="uploadPhoto(mediaChannel.webResolved)" type="file"/>
                            <span class="label-text">Upload Photo/Video</span><i class="fa ft-paperclip ml-1"></i>
                          </label>
                        </div>
                      </div>
                      </div>
                          <div id="" class="" *ngIf=photoVideoToggle>
                              <h4 class="form-section mt-5"><i class="ft-info"></i> Photos</h4>
                                      
                              <!--input *ngIf="auth.authenticated()" type="file" (change)="uploadPhoto()" #fileInput> -->
                              <div class="progress mt-1" *ngIf="progress && progress.percentage < 100">
                                <div class="progress-bar" [style.width]="progress.percentage + '%'">
                                  <span class="sr-only">{{ progress.percentage }}% Complete</span>
                                </div>
                              </div>
                              <div class="right pb-4" *ngIf="isOrgAdminUser">
                                  <h5>Manage Photos</h5>
                                  <div class="form-group">
                                      <ui-switch class="ml-2 float-left" (change)="manageResolutionPhotos()">
                                      </ui-switch>
                                  </div>
                              </div>
                              <div *ngIf="!showManageResolutionPhotos" class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <ng-image-slider [images]="incidenceResolutionPhotos" 
                                [imageSize]="{width: sliderImageWidth, height: sliderImageHeight}" #nav></ng-image-slider>
                              </div>
                              <div *ngIf="showManageResolutionPhotos">
                                <app-photo-editor [photos]="incidenceResolutionPhotos"></app-photo-editor>
                              </div>
                          </div>
                          <div id="" class="" *ngIf=!photoVideoToggle>
                              <div class="videoMaxWrapper">
                              <h4 class="form-section mt-5"><i class="ft-info"></i> Videos</h4>
                              <div class="right pb-4" *ngIf="isOrgAdminUser">
                                  <h5>Manage Videos</h5>
                                  <div class="form-group">
                                      <ui-switch class="ml-2 float-left" (change)="manageResolutionVideos()">
                                      </ui-switch>
                                  </div>
                              </div>
                              <div *ngIf="!showManageResolutionVideos">
                                <ng-image-slider [images]="incidenceResolutionVideos" #nav
                                [imageSize]="{width: sliderImageWidth, height: sliderImageHeight}"></ng-image-slider>
                              </div>
                              <div *ngIf="showManageResolutionVideos">
                                <app-video-editor [videos]="incidenceResolutionVideos"></app-video-editor>
                              </div>
                            </div>
                          </div>
                    </ng-template>
                </ngb-tab>
                  
              </ngb-tabset>
            </div>
          </div>
          <div class="form-actions videoMaxWrapper right">
            <button type="submit" class="btn btn-raised btn-primary mr-2" form="incidentFormId" [disabled]="(incidentForm.invalid && formDir.submitted)">
                <i class="fa fa-check-square-o"></i> Save
            </button>
            <button type="button" class="btn btn-raised btn-warning mr-2" [routerLink]="['/incidences']" >
              <i class="ft-x"></i> Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
  </form>