/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Observable } from 'rxjs';
import html2canvas from 'html2canvas';
import * as XLSX from 'xlsx';
import * as htmlDocx from 'html-docx-js/dist/html-docx';
import html2pdf from 'html2pdf.js';
window['html2canvas'] = html2canvas;
export class ExportAsService {
    constructor() { }
    /**
     * Main base64 get method, it will return the file as base64 string
     * @param {?} config your config
     * @return {?}
     */
    get(config) {
        // structure method name dynamically by type
        /** @type {?} */
        const func = 'get' + config.type.toUpperCase();
        // if type supported execute and return
        if (this[func]) {
            return this[func](config);
        }
        // throw error for unsupported formats
        return Observable.create((observer) => { observer.error('Export type is not supported.'); });
    }
    /**
     * Save exported file in old javascript way
     * @param {?} config your custom config
     * @param {?} fileName Name of the file to be saved as
     * @return {?}
     */
    save(config, fileName) {
        // set download
        config.download = true;
        // get file name with type
        config.fileName = fileName + '.' + config.type;
        this.get(config).subscribe();
    }
    /**
     * Converts content string to blob object
     * @param {?} content string to be converted
     * @return {?}
     */
    contentToBlob(content) {
        return Observable.create((observer) => {
            // get content string and extract mime type
            /** @type {?} */
            const arr = content.split(',');
            /** @type {?} */
            const mime = arr[0].match(/:(.*?);/)[1];
            /** @type {?} */
            const bstr = atob(arr[1]);
            /** @type {?} */
            let n = bstr.length;
            /** @type {?} */
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            observer.next(new Blob([u8arr], { type: mime }));
            observer.complete();
        });
    }
    /**
     * Removes base64 file type from a string like "data:text/csv;base64,"
     * @param {?} fileContent the base64 string to remove the type from
     * @return {?}
     */
    removeFileTypeFromBase64(fileContent) {
        /** @type {?} */
        const re = /^data:[^]*;base64,/g;
        /** @type {?} */
        const newContent = re[Symbol.replace](fileContent, '');
        return newContent;
    }
    /**
     * Structure the base64 file content with the file type string
     * @param {?} fileContent file content
     * @param {?} fileMime file mime type "text/csv"
     * @return {?}
     */
    addFileTypeToBase64(fileContent, fileMime) {
        return `data:${fileMime};base64,${fileContent}`;
    }
    /**
     * create downloadable file from dataURL
     * @param {?} fileName downloadable file name
     * @param {?} dataURL file content as dataURL
     * @return {?}
     */
    downloadFromDataURL(fileName, dataURL) {
        // create blob
        this.contentToBlob(dataURL).subscribe(blob => {
            // download the blob
            this.downloadFromBlob(blob, fileName);
        });
    }
    /**
     * Downloads the blob object as a file
     * @param {?} blob file object as blob
     * @param {?} fileName downloadable file name
     * @return {?}
     */
    downloadFromBlob(blob, fileName) {
        // get object url
        /** @type {?} */
        const url = window.URL.createObjectURL(blob);
        // check for microsoft internet explorer
        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
            // use IE download or open if the user using IE
            window.navigator.msSaveOrOpenBlob(blob, fileName);
        }
        else {
            // if not using IE then create link element
            /** @type {?} */
            const element = document.createElement('a');
            // set download attr with file name
            element.setAttribute('download', fileName);
            // set the element as hidden
            element.style.display = 'none';
            // append the body
            document.body.appendChild(element);
            // set href attr
            element.href = url;
            // click on it to start downloading
            element.click();
            // remove the link from the dom
            document.body.removeChild(element);
        }
    }
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    getPDF(config) {
        return Observable.create((observer) => {
            if (!config.options) {
                config.options = {};
            }
            config.options.filename = config.fileName;
            /** @type {?} */
            const element = document.getElementById(config.elementId);
            /** @type {?} */
            const pdf = html2pdf().set(config.options).from(element, 'element');
            if (config.download) {
                pdf.save();
                observer.next();
                observer.complete();
            }
            else {
                pdf.outputPdf('datauristring').then(data => {
                    observer.next(data);
                    observer.complete();
                });
            }
        });
    }
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    getPNG(config) {
        return Observable.create((observer) => {
            /** @type {?} */
            const element = document.getElementById(config.elementId);
            html2canvas(element, config.options).then((canvas) => {
                /** @type {?} */
                const imgData = canvas.toDataURL('image/PNG');
                if (config.type === 'png' && config.download) {
                    this.downloadFromDataURL(config.fileName, imgData);
                    observer.next();
                }
                else {
                    observer.next(imgData);
                }
                observer.complete();
            }, err => {
                observer.error(err);
            });
        });
    }
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    getCSV(config) {
        return Observable.create((observer) => {
            /** @type {?} */
            const element = document.getElementById(config.elementId);
            /** @type {?} */
            const csv = [];
            /** @type {?} */
            const rows = element.querySelectorAll('table tr');
            for (let index = 0; index < rows.length; index++) {
                /** @type {?} */
                const rowElement = rows[index];
                /** @type {?} */
                const row = [];
                /** @type {?} */
                const cols = rowElement.querySelectorAll('td, th');
                for (let colIndex = 0; colIndex < cols.length; colIndex++) {
                    /** @type {?} */
                    const col = cols[colIndex];
                    row.push(col.innerText);
                }
                csv.push(row.join(','));
            }
            /** @type {?} */
            const csvContent = 'data:text/csv;base64,' + this.btoa(csv.join('\n'));
            if (config.download) {
                this.downloadFromDataURL(config.fileName, csvContent);
                observer.next();
            }
            else {
                observer.next(csvContent);
            }
            observer.complete();
        });
    }
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    getTXT(config) {
        /** @type {?} */
        const nameFrags = config.fileName.split('.');
        config.fileName = `${nameFrags[0]}.txt`;
        return this.getCSV(config);
    }
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    getXLS(config) {
        return Observable.create((observer) => {
            /** @type {?} */
            const element = document.getElementById(config.elementId);
            /** @type {?} */
            const ws3 = XLSX.utils.table_to_sheet(element, config.options);
            /** @type {?} */
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws3, config.fileName);
            /** @type {?} */
            const out = XLSX.write(wb, { type: 'base64' });
            /** @type {?} */
            const xlsContent = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + out;
            if (config.download) {
                this.downloadFromDataURL(config.fileName, xlsContent);
                observer.next();
            }
            else {
                observer.next(xlsContent);
            }
            observer.complete();
        });
    }
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    getXLSX(config) {
        return this.getXLS(config);
    }
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    getDOCX(config) {
        return Observable.create((observer) => {
            /** @type {?} */
            const contentDocument = document.getElementById(config.elementId).outerHTML;
            /** @type {?} */
            const content = '<!DOCTYPE html>' + contentDocument;
            /** @type {?} */
            const converted = htmlDocx.asBlob(content, config.options);
            if (config.download) {
                this.downloadFromBlob(converted, config.fileName);
                observer.next();
                observer.complete();
            }
            else {
                /** @type {?} */
                const reader = new FileReader();
                reader.onloadend = () => {
                    /** @type {?} */
                    const base64data = reader.result;
                    observer.next(base64data);
                    observer.complete();
                };
                reader.readAsDataURL(converted);
            }
        });
    }
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    getDOC(config) {
        return this.getDOCX(config);
    }
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    getJSON(config) {
        return Observable.create((observer) => {
            /** @type {?} */
            const data = [];
            // first row needs to be headers
            /** @type {?} */
            const headers = [];
            /** @type {?} */
            const table = (/** @type {?} */ (document.getElementById(config.elementId)));
            for (let index = 0; index < table.rows[0].cells.length; index++) {
                headers[index] = table.rows[0].cells[index].innerHTML.toLowerCase().replace(/ /gi, '');
            }
            // go through cells
            for (let i = 1; i < table.rows.length; i++) {
                /** @type {?} */
                const tableRow = table.rows[i];
                /** @type {?} */
                const rowData = {};
                for (let j = 0; j < tableRow.cells.length; j++) {
                    rowData[headers[j]] = tableRow.cells[j].innerHTML;
                }
                data.push(rowData);
            }
            /** @type {?} */
            const jsonString = JSON.stringify(data);
            /** @type {?} */
            const jsonBase64 = this.btoa(jsonString);
            /** @type {?} */
            const dataStr = 'data:text/json;base64,' + jsonBase64;
            if (config.download) {
                this.downloadFromDataURL(config.fileName, dataStr);
                observer.next();
            }
            else {
                observer.next(data);
            }
            observer.complete();
        });
    }
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    getXML(config) {
        return Observable.create((observer) => {
            /** @type {?} */
            let xml = '<?xml version="1.0" encoding="UTF-8"?><Root><Classes>';
            /** @type {?} */
            const tritem = document.getElementById(config.elementId).getElementsByTagName('tr');
            for (let i = 0; i < tritem.length; i++) {
                /** @type {?} */
                const celldata = tritem[i];
                if (celldata.cells.length > 0) {
                    xml += '<Class name="' + celldata.cells[0].textContent + '">\n';
                    for (let m = 1; m < celldata.cells.length; ++m) {
                        xml += '\t<data>' + celldata.cells[m].textContent + '</data>\n';
                    }
                    xml += '</Class>\n';
                }
            }
            xml += '</Classes></Root>';
            /** @type {?} */
            const base64 = 'data:text/xml;base64,' + this.btoa(xml);
            if (config.download) {
                this.downloadFromDataURL(config.fileName, base64);
                observer.next();
            }
            else {
                observer.next(base64);
            }
            observer.complete();
        });
    }
    /**
     * @private
     * @param {?} content
     * @return {?}
     */
    btoa(content) {
        return btoa(unescape(encodeURIComponent(content)));
    }
}
ExportAsService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ExportAsService.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwb3J0LWFzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtZXhwb3J0LWFzLyIsInNvdXJjZXMiOlsibGliL2V4cG9ydC1hcy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFJbEMsT0FBTyxXQUFXLE1BQU0sYUFBYSxDQUFDO0FBQ3RDLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxRQUFRLE1BQU0sNkJBQTZCLENBQUM7QUFDeEQsT0FBTyxRQUFRLE1BQU0sYUFBYSxDQUFDO0FBRW5DLE1BQU0sQ0FBQyxhQUFhLENBQUMsR0FBRyxXQUFXLENBQUM7QUFHcEMsTUFBTSxPQUFPLGVBQWU7SUFFMUIsZ0JBQWdCLENBQUM7Ozs7OztJQU1qQixHQUFHLENBQUMsTUFBc0I7OztjQUVsQixJQUFJLEdBQUcsS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFO1FBQzlDLHVDQUF1QztRQUN2QyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNkLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQzNCO1FBRUQsc0NBQXNDO1FBQ3RDLE9BQU8sVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDL0YsQ0FBQzs7Ozs7OztJQU9ELElBQUksQ0FBQyxNQUFzQixFQUFFLFFBQWdCO1FBQzNDLGVBQWU7UUFDZixNQUFNLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUN2QiwwQkFBMEI7UUFDMUIsTUFBTSxDQUFDLFFBQVEsR0FBRyxRQUFRLEdBQUcs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QUFRLEVBQUUsQ0FBQztRQUN0QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Ozs7OztJQUVPLElBQUksQ0FBQyxPQUFlO1FBQzFCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckQsQ0FBQzs7O1lBblNGLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IEV4cG9ydEFzQ29uZmlnIH0gZnJvbSAnLi9leHBvcnQtYXMtY29uZmlnLm1vZGVsJztcblxuaW1wb3J0IGh0bWwyY2FudmFzIGZyb20gJ2h0bWwyY2FudmFzJztcbmltcG9ydCAqIGFzIFhMU1ggZnJvbSAneGxzeCc7XG5pbXBvcnQgKiBhcyBodG1sRG9jeCBmcm9tICdodG1sLWRvY3gtanMvZGlzdC9odG1sLWRvY3gnO1xuaW1wb3J0IGh0bWwycGRmIGZyb20gJ2h0bWwycGRmLmpzJztcblxud2luZG93WydodG1sMmNhbnZhcyddID0gaHRtbDJjYW52YXM7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBFeHBvcnRBc1NlcnZpY2Uge1xuXG4gIGNvbnN0cnVjdG9yKCkgeyB9XG5cbiAgLyoqXG4gICAqIE1haW4gYmFzZTY0IGdldCBtZXRob2QsIGl0IHdpbGwgcmV0dXJuIHRoZSBmaWxlIGFzIGJhc2U2NCBzdHJpbmdcbiAgICogQHBhcmFtIGNvbmZpZyB5b3VyIGNvbmZpZ1xuICAgKi9cbiAgZ2V0KGNvbmZpZzogRXhwb3J0QXNDb25maWcpOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bGw+IHtcbiAgICAvLyBzdHJ1Y3R1cmUgbWV0aG9kIG5hbWUgZHluYW1pY2FsbHkgYnkgdHlwZVxuICAgIGNvbnN0IGZ1bmMgPSAnZ2V0JyArIGNvbmZpZy50eXBlLnRvVXBwZXJDYXNlKCk7XG4gICAgLy8gaWYgdHlwZSBzdXBwb3J0ZWQgZXhlY3V0ZSBhbmQgcmV0dXJuXG4gICAgaWYgKHRoaXNbZnVuY10pIHtcbiAgICAgIHJldHVybiB0aGlzW2Z1bmNdKGNvbmZpZyk7XG4gICAgfVxuXG4gICAgLy8gdGhyb3cgZXJyb3IgZm9yIHVuc3VwcG9ydGVkIGZvcm1hdHNcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyKSA9PiB7IG9ic2VydmVyLmVycm9yKCdFeHBvcnQgdHlwZSBpcyBub3Qgc3VwcG9ydGVkLicpOyB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTYXZlIGV4cG9ydGVkIGZpbGUgaW4gb2xkIGphdmFzY3JpcHQgd2F5XG4gICAqIEBwYXJhbSBjb25maWcgeW91ciBjdXN0b20gY29uZmlnXG4gICAqIEBwYXJhbSBmaWxlTmFtZSBOYW1lIG9mIHRoZSBmaWxlIHRvIGJlIHNhdmVkIGFzXG4gICAqL1xuICBzYXZlKGNvbmZpZzogRXhwb3J0QXNDb25maWcsIGZpbGVOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAvLyBzZXQgZG93bmxvYWRcbiAgICBjb25maWcuZG93bmxvYWQgPSB0cnVlO1xuICAgIC8vIGdldCBmaWxlIG5hbWUgd2l0aCB0eXBlXG4gICAgY29uZmlnLmZpbGVOYW1lID0gZmlsZU5hbWUgKyAnLicgKyBjb25maWcudHlwZTtcbiAgICB0aGlzLmdldChjb25maWcpLnN1YnNjcmliZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnRzIGNvbnRlbnQgc3RyaW5nIHRvIGJsb2Igb2JqZWN0XG4gICAqIEBwYXJhbSBjb250ZW50IHN0cmluZyB0byBiZSBjb252ZXJ0ZWRcbiAgICovXG4gIGNvbnRlbnRUb0Jsb2IoY29udGVudDogc3RyaW5nKTogT2JzZXJ2YWJsZTxCbG9iPiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcikgPT4ge1xuICAgICAgLy8gZ2V0IGNvbnRlbnQgc3RyaW5nIGFuZCBleHRyYWN0IG1pbWUgdHlwZVxuICAgICAgY29uc3QgYXJyID0gY29udGVudC5zcGxpdCgnLCcpLCBtaW1lID0gYXJyWzBdLm1hdGNoKC86KC4qPyk7LylbMV0sXG4gICAgICAgIGJzdHIgPSBhdG9iKGFyclsxXSk7XG4gICAgICBsZXQgbiA9IGJzdHIubGVuZ3RoO1xuICAgICAgY29uc3QgdThhcnIgPSBuZXcgVWludDhBcnJheShuKTtcbiAgICAgIHdoaWxlIChuLS0pIHtcbiAgICAgICAgdThhcnJbbl0gPSBic3RyLmNoYXJDb2RlQXQobik7XG4gICAgICB9XG4gICAgICBvYnNlcnZlci5uZXh0KG5ldyBCbG9iKFt1OGFycl0sIHsgdHlwZTogbWltZSB9KSk7XG4gICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgYmFzZTY0IGZpbGUgdHlwZSBmcm9tIGEgc3RyaW5nIGxpa2UgXCJkYXRhOnRleHQvY3N2O2Jhc2U2NCxcIlxuICAgKiBAcGFyYW0gZmlsZUNvbnRlbnQgdGhlIGJhc2U2NCBzdHJpbmcgdG8gcmVtb3ZlIHRoZSB0eXBlIGZyb21cbiAgICovXG4gIHJlbW92ZUZpbGVUeXBlRnJvbUJhc2U2NChmaWxlQ29udGVudDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCByZSA9IC9eZGF0YTpbXl0qO2Jhc2U2NCwvZztcbiAgICBjb25zdCBuZXdDb250ZW50OiBzdHJpbmcgPSByZVtTeW1ib2wucmVwbGFjZV0oZmlsZUNvbnRlbnQsICcnKTtcbiAgICByZXR1cm4gbmV3Q29udGVudDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdHJ1Y3R1cmUgdGhlIGJhc2U2NCBmaWxlIGNvbnRlbnQgd2l0aCB0aGUgZmlsZSB0eXBlIHN0cmluZ1xuICAgKiBAcGFyYW0gZmlsZUNvbnRlbnQgZmlsZSBjb250ZW50XG4gICAqIEBwYXJhbSBmaWxlTWltZSBmaWxlIG1pbWUgdHlwZSBcInRleHQvY3N2XCJcbiAgICovXG4gIGFkZEZpbGVUeXBlVG9CYXNlNjQoZmlsZUNvbnRlbnQ6IHN0cmluZywgZmlsZU1pbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBkYXRhOiR7ZmlsZU1pbWV9O2Jhc2U2NCwke2ZpbGVDb250ZW50fWA7XG4gIH1cblxuICAvKipcbiAgICogY3JlYXRlIGRvd25sb2FkYWJsZSBmaWxlIGZyb20gZGF0YVVSTFxuICAgKiBAcGFyYW0gZmlsZU5hbWUgZG93bmxvYWRhYmxlIGZpbGUgbmFtZVxuICAgKiBAcGFyYW0gZGF0YVVSTCBmaWxlIGNvbnRlbnQgYXMgZGF0YVVSTFxuICAgKi9cbiAgZG93bmxvYWRGcm9tRGF0YVVSTChmaWxlTmFtZTogc3RyaW5nLCBkYXRhVVJMOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAvLyBjcmVhdGUgYmxvYlxuICAgIHRoaXMuY29udGVudFRvQmxvYihkYXRhVVJMKS5zdWJzY3JpYmUoYmxvYiA9PiB7XG4gICAgICAvLyBkb3dubG9hZCB0aGUgYmxvYlxuICAgICAgdGhpcy5kb3dubG9hZEZyb21CbG9iKGJsb2IsIGZpbGVOYW1lKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEb3dubG9hZHMgdGhlIGJsb2Igb2JqZWN0IGFzIGEgZmlsZVxuICAgKiBAcGFyYW0gYmxvYiBmaWxlIG9iamVjdCBhcyBibG9iXG4gICAqIEBwYXJhbSBmaWxlTmFtZSBkb3dubG9hZGFibGUgZmlsZSBuYW1lXG4gICAqL1xuICBkb3dubG9hZEZyb21CbG9iKGJsb2I6IEJsb2IsIGZpbGVOYW1lOiBzdHJpbmcpIHtcbiAgICAvLyBnZXQgb2JqZWN0IHVybFxuICAgIGNvbnN0IHVybCA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xuICAgIC8vIGNoZWNrIGZvciBtaWNyb3NvZnQgaW50ZXJuZXQgZXhwbG9yZXJcbiAgICBpZiAod2luZG93Lm5hdmlnYXRvciAmJiB3aW5kb3cubmF2aWdhdG9yLm1zU2F2ZU9yT3BlbkJsb2IpIHtcbiAgICAgIC8vIHVzZSBJRSBkb3dubG9hZCBvciBvcGVuIGlmIHRoZSB1c2VyIHVzaW5nIElFXG4gICAgICB3aW5kb3cubmF2aWdhdG9yLm1zU2F2ZU9yT3BlbkJsb2IoYmxvYiwgZmlsZU5hbWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBpZiBub3QgdXNpbmcgSUUgdGhlbiBjcmVhdGUgbGluayBlbGVtZW50XG4gICAgICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xuICAgICAgLy8gc2V0IGRvd25sb2FkIGF0dHIgd2l0aCBmaWxlIG5hbWVcbiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdkb3dubG9hZCcsIGZpbGVOYW1lKTtcbiAgICAgIC8vIHNldCB0aGUgZWxlbWVudCBhcyBoaWRkZW5cbiAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgIC8vIGFwcGVuZCB0aGUgYm9keVxuICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlbGVtZW50KTtcbiAgICAgIC8vIHNldCBocmVmIGF0dHJcbiAgICAgIGVsZW1lbnQuaHJlZiA9IHVybDtcbiAgICAgIC8vIGNsaWNrIG9uIGl0IHRvIHN0YXJ0IGRvd25sb2FkaW5nXG4gICAgICBlbGVtZW50LmNsaWNrKCk7XG4gICAgICAvLyByZW1vdmUgdGhlIGxpbmsgZnJvbSB0aGUgZG9tXG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGVsZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0UERGKGNvbmZpZzogRXhwb3J0QXNDb25maWcpOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bGw+IHtcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyKSA9PiB7XG4gICAgICBpZiAoIWNvbmZpZy5vcHRpb25zKSB7XG4gICAgICAgIGNvbmZpZy5vcHRpb25zID0ge307XG4gICAgICB9XG4gICAgICBjb25maWcub3B0aW9ucy5maWxlbmFtZSA9IGNvbmZpZy5maWxlTmFtZTtcbiAgICAgIGNvbnN0IGVsZW1lbnQ6IEhUTUxFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29uZmlnLmVsZW1lbnRJZCk7XG4gICAgICBjb25zdCBwZGYgPSBodG1sMnBkZigpLnNldChjb25maWcub3B0aW9ucykuZnJvbShlbGVtZW50LCAnZWxlbWVudCcpO1xuICAgICAgaWYgKGNvbmZpZy5kb3dubG9hZCkge1xuICAgICAgICBwZGYuc2F2ZSgpO1xuICAgICAgICBvYnNlcnZlci5uZXh0KCk7XG4gICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwZGYub3V0cHV0UGRmKCdkYXRhdXJpc3RyaW5nJykudGhlbihkYXRhID0+IHtcbiAgICAgICAgICBvYnNlcnZlci5uZXh0KGRhdGEpO1xuICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQTkcoY29uZmlnOiBFeHBvcnRBc0NvbmZpZyk6IE9ic2VydmFibGU8c3RyaW5nIHwgbnVsbD4ge1xuICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZSgob2JzZXJ2ZXIpID0+IHtcbiAgICAgIGNvbnN0IGVsZW1lbnQ6IEhUTUxFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29uZmlnLmVsZW1lbnRJZCk7XG4gICAgICBodG1sMmNhbnZhcyhlbGVtZW50LCBjb25maWcub3B0aW9ucykudGhlbigoY2FudmFzKSA9PiB7XG4gICAgICAgIGNvbnN0IGltZ0RhdGEgPSBjYW52YXMudG9EYXRhVVJMKCdpbWFnZS9QTkcnKTtcbiAgICAgICAgaWYgKGNvbmZpZy50eXBlID09PSAncG5nJyAmJiBjb25maWcuZG93bmxvYWQpIHtcbiAgICAgICAgICB0aGlzLmRvd25sb2FkRnJvbURhdGFVUkwoY29uZmlnLmZpbGVOYW1lLCBpbWdEYXRhKTtcbiAgICAgICAgICBvYnNlcnZlci5uZXh0KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChpbWdEYXRhKTtcbiAgICAgICAgfVxuICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgfSwgZXJyID0+IHtcbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDU1YoY29uZmlnOiBFeHBvcnRBc0NvbmZpZyk6IE9ic2VydmFibGU8c3RyaW5nIHwgbnVsbD4ge1xuICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZSgob2JzZXJ2ZXIpID0+IHtcbiAgICAgIGNvbnN0IGVsZW1lbnQ6IEhUTUxFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29uZmlnLmVsZW1lbnRJZCk7XG4gICAgICBjb25zdCBjc3YgPSBbXTtcbiAgICAgIGNvbnN0IHJvd3M6IGFueSA9IGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgndGFibGUgdHInKTtcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCByb3dzLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICBjb25zdCByb3dFbGVtZW50ID0gcm93c1tpbmRleF07XG4gICAgICAgIGNvbnN0IHJvdyA9IFtdO1xuICAgICAgICBjb25zdCBjb2xzID0gcm93RWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCd0ZCwgdGgnKTtcbiAgICAgICAgZm9yIChsZXQgY29sSW5kZXggPSAwOyBjb2xJbmRleCA8IGNvbHMubGVuZ3RoOyBjb2xJbmRleCsrKSB7XG4gICAgICAgICAgY29uc3QgY29sID0gY29sc1tjb2xJbmRleF07XG4gICAgICAgICAgcm93LnB1c2goY29sLmlubmVyVGV4dCk7XG4gICAgICAgIH1cbiAgICAgICAgY3N2LnB1c2gocm93LmpvaW4oJywnKSk7XG4gICAgICB9XG4gICAgICBjb25zdCBjc3ZDb250ZW50ID0gJ2RhdGE6dGV4dC9jc3Y7YmFzZTY0LCcgKyB0aGlzLmJ0b2EoY3N2LmpvaW4oJ1xcbicpKTtcbiAgICAgIGlmIChjb25maWcuZG93bmxvYWQpIHtcbiAgICAgICAgdGhpcy5kb3dubG9hZEZyb21EYXRhVVJMKGNvbmZpZy5maWxlTmFtZSwgY3N2Q29udGVudCk7XG4gICAgICAgIG9ic2VydmVyLm5leHQoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9ic2VydmVyLm5leHQoY3N2Q29udGVudCk7XG4gICAgICB9XG4gICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRUWFQoY29uZmlnOiBFeHBvcnRBc0NvbmZpZyk6IE9ic2VydmFibGU8c3RyaW5nIHwgbnVsbD4ge1xuICAgIGNvbnN0IG5hbWVGcmFncyA9IGNvbmZpZy5maWxlTmFtZS5zcGxpdCgnLicpO1xuICAgIGNvbmZpZy5maWxlTmFtZSA9IGAke25hbWVGcmFnc1swXX0udHh0YDtcbiAgICByZXR1cm4gdGhpcy5nZXRDU1YoY29uZmlnKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0WExTKGNvbmZpZzogRXhwb3J0QXNDb25maWcpOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bGw+IHtcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyKSA9PiB7XG5cbiAgICAgIGNvbnN0IGVsZW1lbnQ6IEhUTUxFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29uZmlnLmVsZW1lbnRJZCk7XG4gICAgICBjb25zdCB3czMgPSBYTFNYLnV0aWxzLnRhYmxlX3RvX3NoZWV0KGVsZW1lbnQsIGNvbmZpZy5vcHRpb25zKTtcbiAgICAgIGNvbnN0IHdiID0gWExTWC51dGlscy5ib29rX25ldygpO1xuICAgICAgWExTWC51dGlscy5ib29rX2FwcGVuZF9zaGVldCh3Yiwgd3MzLCBjb25maWcuZmlsZU5hbWUpO1xuICAgICAgY29uc3Qgb3V0ID0gWExTWC53cml0ZSh3YiwgeyB0eXBlOiAnYmFzZTY0JyB9KTtcbiAgICAgIGNvbnN0IHhsc0NvbnRlbnQgPSAnZGF0YTphcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC5zaGVldDtiYXNlNjQsJyArIG91dDtcbiAgICAgIGlmIChjb25maWcuZG93bmxvYWQpIHtcbiAgICAgICAgdGhpcy5kb3dubG9hZEZyb21EYXRhVVJMKGNvbmZpZy5maWxlTmFtZSwgeGxzQ29udGVudCk7XG4gICAgICAgIG9ic2VydmVyLm5leHQoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9ic2VydmVyLm5leHQoeGxzQ29udGVudCk7XG4gICAgICB9XG4gICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRYTFNYKGNvbmZpZzogRXhwb3J0QXNDb25maWcpOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRYTFMoY29uZmlnKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RE9DWChjb25maWc6IEV4cG9ydEFzQ29uZmlnKTogT2JzZXJ2YWJsZTxzdHJpbmcgfCBudWxsPiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcikgPT4ge1xuICAgICAgY29uc3QgY29udGVudERvY3VtZW50OiBzdHJpbmcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChjb25maWcuZWxlbWVudElkKS5vdXRlckhUTUw7XG4gICAgICBjb25zdCBjb250ZW50ID0gJzwhRE9DVFlQRSBodG1sPicgKyBjb250ZW50RG9jdW1lbnQ7XG4gICAgICBjb25zdCBjb252ZXJ0ZWQgPSBodG1sRG9jeC5hc0Jsb2IoY29udGVudCwgY29uZmlnLm9wdGlvbnMpO1xuICAgICAgaWYgKGNvbmZpZy5kb3dubG9hZCkge1xuICAgICAgICB0aGlzLmRvd25sb2FkRnJvbUJsb2IoY29udmVydGVkLCBjb25maWcuZmlsZU5hbWUpO1xuICAgICAgICBvYnNlcnZlci5uZXh0KCk7XG4gICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgICAgICByZWFkZXIub25sb2FkZW5kID0gKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGJhc2U2NGRhdGEgPSByZWFkZXIucmVzdWx0O1xuICAgICAgICAgIG9ic2VydmVyLm5leHQoYmFzZTY0ZGF0YSk7XG4gICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgfTtcbiAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoY29udmVydGVkKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RE9DKGNvbmZpZzogRXhwb3J0QXNDb25maWcpOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRET0NYKGNvbmZpZyk7XG4gIH1cblxuICBwcml2YXRlIGdldEpTT04oY29uZmlnOiBFeHBvcnRBc0NvbmZpZyk6IE9ic2VydmFibGU8YW55W10gfCBudWxsPiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcikgPT4ge1xuICAgICAgY29uc3QgZGF0YSA9IFtdOyAvLyBmaXJzdCByb3cgbmVlZHMgdG8gYmUgaGVhZGVyc1xuICAgICAgY29uc3QgaGVhZGVycyA9IFtdO1xuICAgICAgY29uc3QgdGFibGUgPSA8SFRNTFRhYmxlRWxlbWVudD5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChjb25maWcuZWxlbWVudElkKTtcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0YWJsZS5yb3dzWzBdLmNlbGxzLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICBoZWFkZXJzW2luZGV4XSA9IHRhYmxlLnJvd3NbMF0uY2VsbHNbaW5kZXhdLmlubmVySFRNTC50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoLyAvZ2ksICcnKTtcbiAgICAgIH1cbiAgICAgIC8vIGdvIHRocm91Z2ggY2VsbHNcbiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgdGFibGUucm93cy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCB0YWJsZVJvdyA9IHRhYmxlLnJvd3NbaV07IGNvbnN0IHJvd0RhdGEgPSB7fTtcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0YWJsZVJvdy5jZWxscy5sZW5ndGg7IGorKykge1xuICAgICAgICAgIHJvd0RhdGFbaGVhZGVyc1tqXV0gPSB0YWJsZVJvdy5jZWxsc1tqXS5pbm5lckhUTUw7XG4gICAgICAgIH1cbiAgICAgICAgZGF0YS5wdXNoKHJvd0RhdGEpO1xuICAgICAgfVxuICAgICAgY29uc3QganNvblN0cmluZyA9IEpTT04uc3RyaW5naWZ5KGRhdGEpO1xuICAgICAgY29uc3QganNvbkJhc2U2NCA9IHRoaXMuYnRvYShqc29uU3RyaW5nKTtcbiAgICAgIGNvbnN0IGRhdGFTdHIgPSAnZGF0YTp0ZXh0L2pzb247YmFzZTY0LCcgKyBqc29uQmFzZTY0O1xuICAgICAgaWYgKGNvbmZpZy5kb3dubG9hZCkge1xuICAgICAgICB0aGlzLmRvd25sb2FkRnJvbURhdGFVUkwoY29uZmlnLmZpbGVOYW1lLCBkYXRhU3RyKTtcbiAgICAgICAgb2JzZXJ2ZXIubmV4dCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb2JzZXJ2ZXIubmV4dChkYXRhKTtcbiAgICAgIH1cbiAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldFhNTChjb25maWc6IEV4cG9ydEFzQ29uZmlnKTogT2JzZXJ2YWJsZTxzdHJpbmcgfCBudWxsPiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcikgPT4ge1xuICAgICAgbGV0IHhtbCA9ICc8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJVVEYtOFwiPz48Um9vdD48Q2xhc3Nlcz4nO1xuICAgICAgY29uc3QgdHJpdGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29uZmlnLmVsZW1lbnRJZCkuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3RyJyk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRyaXRlbS5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBjZWxsZGF0YSA9IHRyaXRlbVtpXTtcbiAgICAgICAgaWYgKGNlbGxkYXRhLmNlbGxzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICB4bWwgKz0gJzxDbGFzcyBuYW1lPVwiJyArIGNlbGxkYXRhLmNlbGxzWzBdLnRleHRDb250ZW50ICsgJ1wiPlxcbic7XG4gICAgICAgICAgZm9yIChsZXQgbSA9IDE7IG0gPCBjZWxsZGF0YS5jZWxscy5sZW5ndGg7ICsrbSkge1xuICAgICAgICAgICAgeG1sICs9ICdcXHQ8ZGF0YT4nICsgY2VsbGRhdGEuY2VsbHNbbV0udGV4dENvbnRlbnQgKyAnPC9kYXRhPlxcbic7XG4gICAgICAgICAgfVxuICAgICAgICAgIHhtbCArPSAnPC9DbGFzcz5cXG4nO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB4bWwgKz0gJzwvQ2xhc3Nlcz48L1Jvb3Q+JztcbiAgICAgIGNvbnN0IGJhc2U2NCA9ICdkYXRhOnRleHQveG1sO2Jhc2U2NCwnICsgdGhpcy5idG9hKHhtbCk7XG4gICAgICBpZiAoY29uZmlnLmRvd25sb2FkKSB7XG4gICAgICAgIHRoaXMuZG93bmxvYWRGcm9tRGF0YVVSTChjb25maWcuZmlsZU5hbWUsIGJhc2U2NCk7XG4gICAgICAgIG9ic2VydmVyLm5leHQoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9ic2VydmVyLm5leHQoYmFzZTY0KTtcbiAgICAgIH1cbiAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGJ0b2EoY29udGVudDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGNvbnRlbnQpKSk7XG4gIH1cblxufVxuIl19